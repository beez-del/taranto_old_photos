<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <title>Mapa Taranto â€“ MapLibre + Fotky</title>
  <link href="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.js"></script>
  <style>
    body, #map { margin:0; padding:0; height:100vh; }
    .popup-img { max-width:200px; border-radius:8px; }
    .maplibregl-popup-content { padding: 10px; }
    .maplibregl-popup-content h3 { margin: 0 0 10px 0; }
    
    .style-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      z-index: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .style-indicator.maptiler { background: #e3f2fd; color: #1976d2; }
    .style-indicator.free { background: #e8f5e9; color: #388e3c; }
    .style-indicator.error { background: #ffebee; color: #c62828; }
    .style-indicator.loading { background: #fff3e0; color: #f57c00; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="style-indicator loading" id="styleIndicator">â³ NaÄÃ­tÃ¡m mapu...</div>
<button id="resetBtn" style="position:absolute; bottom:10px; right:10px; z-index:1; padding:8px 12px; background:#fff; border:1px solid #ccc; border-radius:4px; cursor:pointer; font-size:12px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
  ğŸ”„ Reset cache
</button>

<script>
  // ============================================
  // KONFIGURACE
  // ============================================
  
  const PREFER_MAPTILER = true;  // â† ChceÅ¡ primÃ¡rnÄ› MapTiler?
  const AUTO_FALLBACK = true;    // â† Automaticky pÅ™epnout pÅ™i chybÄ›?
  
  // ============================================
  // INTELIGENTNÃ VÃBÄšR STYLU
  // ============================================
  
  let currentProvider = 'maptiler';
  let map = null;
  
  // Kontrola, jestli uÅ¾ dÅ™Ã­ve selhal MapTiler (v localStorage)
  const maptilerFailed = localStorage.getItem('maptiler-failed') === 'true';
  
  if (maptilerFailed && AUTO_FALLBACK) {
    console.warn('âš ï¸ MapTiler dÅ™Ã­ve selhal, pouÅ¾Ã­vÃ¡m OpenFreeMap');
    currentProvider = 'free';
  } else if (PREFER_MAPTILER) {
    currentProvider = 'maptiler';
  } else {
    currentProvider = 'free';
  }
  
  const mapStyle = currentProvider === 'maptiler' 
    ? './my-style.json' 
    : './my-style-free.json';

  // ============================================
  // INICIALIZACE MAPY
  // ============================================
  
  function initMap() {
    map = new maplibregl.Map({
      container: 'map',
      style: mapStyle,
      bounds: [
        [17.2052900, 40.4305000], // Southwest (levÃ½ dolnÃ­ roh)
        [17.2926700, 40.5021700]  // Northeast (pravÃ½ hornÃ­ roh)
      ],
      fitBoundsOptions: {
        padding: 20
      }
    });

    map.addControl(new maplibregl.NavigationControl());

    // ============================================
    // DETEKCE CHYB A AUTOMATICKÃ FALLBACK
    // ============================================
    
    let errorCount = 0;
    const MAX_ERRORS = 3;
    
    map.on('error', (e) => {
      console.error('âŒ Chyba mapy:', e);
      errorCount++;
      
      const indicator = document.getElementById('styleIndicator');
      
      // Detekce chyb API klÃ­Äe nebo rate limitu
      const errorObj = e.error || e;
      const errorStatus = errorObj.status;
      const errorMessage = errorObj.message || '';
      
      const is401 = errorStatus === 401 || errorStatus === 403;
      const is429 = errorStatus === 429; // Rate limit
      const isTileError = errorMessage.includes('tiles') || 
                         errorMessage.includes('source') ||
                         errorObj.url;
      
      console.log('Debug chyby:', { 
        status: errorStatus, 
        message: errorMessage,
        provider: currentProvider,
        errorCount 
      });
      
      // Pouze pokud je to MapTiler a skuteÄnÃ¡ chyba API
      if ((is401 || is429) && currentProvider === 'maptiler') {
        console.error('ğŸš¨ MapTiler API problÃ©m detekovÃ¡n');
        
        if (AUTO_FALLBACK) {
          indicator.textContent = 'âš ï¸ PÅ™epÃ­nÃ¡m na zÃ¡loÅ¾nÃ­ mapu...';
          indicator.className = 'style-indicator error';
          
          localStorage.setItem('maptiler-failed', 'true');
          
          setTimeout(() => {
            console.log('ğŸ”„ Restartuji s OSM fallback...');
            currentProvider = 'free';
            map.remove();
            location.reload();
          }, 2000);
        } else {
          indicator.textContent = 'âŒ MapTiler nedostupnÃ½';
          indicator.className = 'style-indicator error';
        }
      } 
      // Pokud je free provider a mÃ¡ hodnÄ› chyb, je problÃ©m
      else if (currentProvider === 'free' && errorCount > MAX_ERRORS) {
        console.warn('âš ï¸ PÅ™Ã­liÅ¡ mnoho chyb u free providera');
        indicator.textContent = 'âš ï¸ ProblÃ©my s naÄÃ­tÃ¡nÃ­m';
        indicator.className = 'style-indicator error';
      }
    });

    // ============================================
    // NAÄŒTENÃ DAT PO STARTU MAPY
    // ============================================
    
    map.on('load', () => {
      console.log(`âœ… Mapa naÄtena! Provider: ${currentProvider}`);
      
      const indicator = document.getElementById('styleIndicator');
      if (currentProvider === 'maptiler') {
        indicator.textContent = 'ğŸ”‘ MapTiler';
        indicator.className = 'style-indicator maptiler';
        // VyÄisti localStorage pokud funguje
        localStorage.removeItem('maptiler-failed');
      } else {
        indicator.textContent = 'ğŸŒ OpenFreeMap';
        indicator.className = 'style-indicator free';
      }
      
      loadMapData();
    });
  }
  
  // ============================================
  // NAÄŒTENÃ GEOJSON DAT
  // ============================================
  
  function loadMapData() {
    // --- Hranice mÄ›sta (skrytÃ©, jen pro referenci) ---
    fetch('./taranto.geojson')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log('âœ… Taranto data naÄtena (hranice skryty)');
        // PÅ™idÃ¡me source, ale nevytvoÅ™Ã­me layer - hranice nebudou vidÄ›t
        map.addSource('taranto', { type: 'geojson', data });
      })
      .catch(err => {
        console.error('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ taranto.geojson:', err);
      });

    // --- Fotky ---
    fetch('./photos.geojson')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log('âœ… Photos data naÄtena');
        map.addSource('photos', { type: 'geojson', data });
        
        map.addLayer({
          id: 'photo-points',
          type: 'circle',
          source: 'photos',
          paint: {
            'circle-radius': 10,
            'circle-color': '#FF4444',
            'circle-stroke-color': '#FFFFFF',
            'circle-stroke-width': 3,
            'circle-opacity': 0.9
          }
        });

        // Popup
        map.on('click', 'photo-points', (e) => {
          const coords = e.features[0].geometry.coordinates.slice();
          const props = e.features[0].properties;
          new maplibregl.Popup()
            .setLngLat(coords)
            .setHTML(`
              <h3>${props.title}</h3>
              <img class="popup-img" src="${props.url}" alt="${props.title}"/>
            `)
            .addTo(map);
        });

        map.on('mouseenter', 'photo-points', () => { 
          map.getCanvas().style.cursor = 'pointer'; 
        });
        map.on('mouseleave', 'photo-points', () => { 
          map.getCanvas().style.cursor = ''; 
        });
      })
      .catch(err => {
        console.error('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ photos.geojson:', err);
      });
  }
  
  // ============================================
  // START
  // ============================================
  
  initMap();
  
  // Reset cache tlaÄÃ­tko
  document.getElementById('resetBtn').addEventListener('click', () => {
    if (confirm('Vymazat cache a zkusit znovu MapTiler?')) {
      localStorage.clear();
      alert('Cache vymazÃ¡na! StrÃ¡nka se restartuje...');
      location.reload();
    }
  });
  
  // Debug info do konzole
  console.log('ğŸ—ºï¸ MapovÃ¡ aplikace Taranto');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Provider:', currentProvider);
  console.log('Auto-fallback:', AUTO_FALLBACK ? 'ANO âœ…' : 'NE âŒ');
  console.log('MapTiler dÅ™Ã­ve selhal?', maptilerFailed ? 'ANO âš ï¸' : 'NE');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ’¡ Pro reset cache: localStorage.clear() nebo klikni na tlaÄÃ­tko');

</script>
</body>
</html>

